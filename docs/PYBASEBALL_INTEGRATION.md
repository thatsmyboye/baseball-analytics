# Pybaseball Integration Plan

## Phase 1: Player ID Discovery (Immediate Win)

### Current Problem
Finding FanGraphs API IDs is manual and unreliable.

### Pybaseball Solution
```python
from pybaseball import playerid_lookup

# Find player IDs automatically
result = playerid_lookup('harper', 'bryce')
# Returns: name_last, name_first, key_mlbam, key_retro, key_bbref, key_fangraphs, mlb_played_first, mlb_played_last

fg_id = result['key_fangraphs'].iloc[0]
```

### Implementation

Create `src/scrapers/pybaseball_lookup.py`:
```python
"""
Use pybaseball to find FanGraphs IDs
"""
from pybaseball import playerid_lookup, cache
import pandas as pd

# Enable caching to avoid repeated requests
cache.enable()

def find_fangraphs_id(last_name, first_name=None):
    """
    Look up a player's FanGraphs ID
    
    Args:
        last_name: Player's last name
        first_name: Player's first name (optional, improves accuracy)
    
    Returns:
        dict with player info including FanGraphs ID
    """
    
    try:
        if first_name:
            results = playerid_lookup(last_name, first_name)
        else:
            results = playerid_lookup(last_name)
        
        if results is None or results.empty:
            print(f"No results found for {first_name} {last_name}")
            return None
        
        # Return first result
        player = results.iloc[0]
        
        return {
            'name': f"{player['name_first']} {player['name_last']}",
            'fg_id': str(int(player['key_fangraphs'])) if pd.notna(player['key_fangraphs']) else None,
            'mlbam_id': str(int(player['key_mlbam'])) if pd.notna(player['key_mlbam']) else None,
            'bbref_id': player['key_bbref'],
            'debut': player['mlb_played_first'],
            'last_season': player['mlb_played_last']
        }
        
    except Exception as e:
        print(f"Error looking up {first_name} {last_name}: {e}")
        return None


def bulk_lookup_from_names(player_names):
    """
    Look up FanGraphs IDs for multiple players
    
    Args:
        player_names: List of (first_name, last_name) tuples
    
    Returns:
        List of dicts with player info
    """
    
    results = []
    
    for first, last in player_names:
        print(f"Looking up {first} {last}...")
        info = find_fangraphs_id(last, first)
        
        if info and info['fg_id']:
            results.append(info)
            print(f"  âœ… Found FG ID: {info['fg_id']}")
        else:
            print(f"  âŒ No FanGraphs ID found")
    
    return results


def export_to_verified_players(results, output_file='verified_players_export.py'):
    """
    Export results in verified_players.py format
    """
    
    with open(output_file, 'w') as f:
        f.write("# Generated by pybaseball lookup\n\n")
        f.write("VERIFIED_PLAYERS = [\n")
        
        for player in results:
            f.write(f'    ("{player["name"]}", "{player["fg_id"]}"),\n')
        
        f.write("]\n")
    
    print(f"\nğŸ“ Exported to {output_file}")


if __name__ == "__main__":
    # Example: Look up some players
    players_to_add = [
        ('Bryce', 'Harper'),
        ('Freddie', 'Freeman'),
        ('Manny', 'Machado'),
        ('Jose', 'Altuve'),
        ('Ronald', 'Acuna'),
    ]
    
    results = bulk_lookup_from_names(players_to_add)
    
    if results:
        export_to_verified_players(results)
        
        print("\nğŸ“Š Summary:")
        print(f"   Found {len(results)}/{len(players_to_add)} players")
        print("\n   Copy these to src/data/verified_players.py")
```

---

## Phase 2: Replace FanGraphs Scraper (Medium Term)

### Current Approach
Custom scraper hitting FanGraphs API endpoints.

### Pybaseball Approach
```python
from pybaseball import batting_stats

# Get all batting stats for a season
stats_2025 = batting_stats(2025, qual=50)  # Min 50 PA

# Get specific player
from pybaseball import playerid_lookup, batting_stats_range

# Method 1: Get by season range
stats = batting_stats_range('2015-01-01', '2025-12-31')

# Method 2: Use FanGraphs directly
from pybaseball import fg_batting_data
stats = fg_batting_data(2015, 2025, qual=50)
```

### Implementation

Create `src/scrapers/pybaseball_stats.py`:
```python
"""
Use pybaseball to fetch stats instead of custom scraper
"""
from pybaseball import batting_stats, cache
import pandas as pd

cache.enable()

def get_player_stats_pybaseball(start_year=2015, end_year=2025, min_pa=50):
    """
    Get batting stats using pybaseball
    
    Returns:
        DataFrame with all qualified players
    """
    
    all_seasons = []
    
    for year in range(start_year, end_year + 1):
        print(f"Fetching {year} season...")
        
        try:
            season_stats = batting_stats(year, qual=min_pa)
            season_stats['Season'] = year
            all_seasons.append(season_stats)
            
        except Exception as e:
            print(f"  Error fetching {year}: {e}")
    
    if all_seasons:
        combined = pd.concat(all_seasons, ignore_index=True)
        print(f"\nâœ… Retrieved {len(combined)} player-seasons")
        return combined
    
    return None


def map_to_database_schema(pybaseball_df):
    """
    Convert pybaseball format to our database schema
    
    Pybaseball column names differ from our current schema
    """
    
    mapping = {
        'Name': 'name',
        'Season': 'season',
        'Team': 'team',
        'G': 'games',
        'PA': 'pa',
        'AB': 'ab',
        'H': 'hits',
        '2B': 'doubles',
        '3B': 'triples',
        'HR': 'hr',
        'RBI': 'rbi',
        'BB': 'bb',
        'SO': 'so',
        'AVG': 'avg',
        'OBP': 'obp',
        'SLG': 'slg',
        'wOBA': 'woba',
        'wRC+': 'wrc_plus',
        'BABIP': 'babip',
        'BB%': 'bb_pct',
        'K%': 'k_pct',
        'ISO': 'iso',
        'GB%': 'gb_pct',
        'FB%': 'fb_pct',
        'LD%': 'ld_pct',
        'HR/FB': 'hr_fb_pct',
    }
    
    # Create new dataframe with mapped columns
    mapped_df = pd.DataFrame()
    
    for old_col, new_col in mapping.items():
        if old_col in pybaseball_df.columns:
            mapped_df[new_col] = pybaseball_df[old_col]
    
    return mapped_df
```

---

## Phase 3: Add Statcast Data (High Value)

### New Capability
Hard-hit rate, exit velocity, barrel%, launch angle - metrics we don't have!

### Implementation

Create `src/scrapers/statcast_integration.py`:
```python
"""
Add Statcast data using pybaseball
"""
from pybaseball import statcast_batter, cache
import pandas as pd
from datetime import datetime

cache.enable()

def get_statcast_season(player_id, season):
    """
    Get Statcast data for a player's season
    
    Args:
        player_id: MLB AM ID (different from FanGraphs ID!)
        season: Year
    
    Returns:
        Aggregated Statcast metrics
    """
    
    start_date = f"{season}-03-01"
    end_date = f"{season}-11-01"
    
    try:
        # Get all batted balls for player
        data = statcast_batter(start_date, end_date, player_id)
        
        if data is None or data.empty:
            return None
        
        # Aggregate metrics
        metrics = {
            'exit_velo': data['launch_speed'].mean(),
            'launch_angle': data['launch_angle'].mean(),
            'barrel_pct': (data['barrel'] == 1).sum() / len(data) * 100,
            'hard_hit_pct': (data['launch_speed'] >= 95).sum() / len(data) * 100,
            'sweet_spot_pct': ((data['launch_angle'] >= 8) & (data['launch_angle'] <= 32)).sum() / len(data) * 100,
        }
        
        return metrics
        
    except Exception as e:
        print(f"Error getting Statcast for player {player_id}: {e}")
        return None


def add_statcast_to_database(player_name, mlbam_id, season):
    """
    Add Statcast data to statcast_data table
    """
    
    from src.utils.db_connection import get_session
    from sqlalchemy import text
    
    session = get_session()
    
    try:
        # Get player_id from database
        result = session.execute(
            text("SELECT player_id FROM players WHERE name = :name"),
            {'name': player_name}
        ).fetchone()
        
        if not result:
            print(f"Player {player_name} not in database")
            return
        
        player_id = result[0]
        
        # Get Statcast data
        metrics = get_statcast_season(mlbam_id, season)
        
        if not metrics:
            print(f"No Statcast data for {player_name} in {season}")
            return
        
        # Insert/update statcast_data table
        session.execute(
            text("""
                INSERT INTO statcast_data 
                (player_id, season, exit_velo, launch_angle, barrel_pct, hard_hit_pct)
                VALUES (:player_id, :season, :exit_velo, :launch_angle, :barrel_pct, :hard_hit_pct)
                ON CONFLICT (player_id, season) 
                DO UPDATE SET
                    exit_velo = EXCLUDED.exit_velo,
                    launch_angle = EXCLUDED.launch_angle,
                    barrel_pct = EXCLUDED.barrel_pct,
                    hard_hit_pct = EXCLUDED.hard_hit_pct,
                    uploaded_at = CURRENT_TIMESTAMP
            """),
            {
                'player_id': player_id,
                'season': season,
                'exit_velo': metrics['exit_velo'],
                'launch_angle': metrics['launch_angle'],
                'barrel_pct': metrics['barrel_pct'],
                'hard_hit_pct': metrics['hard_hit_pct']
            }
        )
        
        session.commit()
        print(f"âœ… Added Statcast data for {player_name} ({season})")
        
    finally:
        session.close()
```

---

## Phase 4: Enhanced Regression Detection

With Statcast, we can add new regression signals:
```python
# In regression_detector.py, add:

def detect_statcast_regression(self, current_hard_hit, career_hard_hit, 
                                current_barrel_pct, career_barrel_pct):
    """
    Detect regression using Statcast data
    
    Hard-hit% and Barrel% are more predictive than BABIP
    """
    
    hard_hit_delta = current_hard_hit - career_hard_hit
    barrel_delta = current_barrel_pct - career_barrel_pct
    
    # If BABIP is high but hard-hit% is low = SELL
    # If BABIP is low but hard-hit% is high = BUY
    
    ...
```

---

## Migration Strategy

### Week 1: Player ID Discovery
```bash
pip install pybaseball
python src/scrapers/pybaseball_lookup.py
# Add 50-100 new players easily
```

### Week 2: Parallel Testing
- Keep current scraper
- Add pybaseball scraper
- Compare results for accuracy

### Week 3: Statcast Integration
- Add statcast_data population
- Enhance regression detection

### Week 4: Full Migration
- Replace custom scraper with pybaseball
- Update daily_scraper.py
- Deprecate old methods

---

## Installation
```bash
pip install pybaseball
```

Add to `requirements.txt`:
```
pybaseball>=2.2.7
```

---

## Benefits Summary

| Feature | Current | With Pybaseball |
|---------|---------|-----------------|
| Player count | 53 (hard to expand) | Unlimited (easy lookup) |
| ID discovery | Manual, unreliable | Automatic |
| Statcast data | âŒ None | âœ… Full integration |
| Pitching stats | âŒ None | âœ… Available |
| Maintenance | High (custom scraper) | Low (maintained library) |
| Data quality | Good | Excellent (validated) |

---

## Risks & Considerations

**Pros:**
- âœ… Solves ID discovery problem completely
- âœ… Adds Statcast (huge analytical value)
- âœ… Well-maintained, active community
- âœ… Handles API changes automatically

**Cons:**
- âš ï¸ Dependency on external library
- âš ï¸ Might have rate limiting
- âš ï¸ Different column names (requires mapping)

**Recommendation:** **Integrate pybaseball immediately for ID lookup, then gradually for stats.**